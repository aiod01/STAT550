---
title: "Senior Worker 450 Code"
author: "Zhen Liu, Yutong Liu, Jingyi Huang"
date: "2018/2/1"
output: html_document
---

```{r data input}
s<-getwd()
substr(s, 1, nchar(s)-4)
path<-paste(substr(s, 1, nchar(s)-4),"Data/Data-NFEHRS_revised.sav",sep = "")
library(haven)
Rawdata<- read_sav(path)  #1247
```

## Data Pre-processing
### 1. Check Response
```{r response skil_num}
summary(Rawdata$num_use)
nrow(Rawdata[Rawdata$num_use==7,])  
```
The max of num_use is 5 so I guessed 7 may be a wrong input. Also, there are other four missing value in this observation.Therefore, we'll use the dataset that exclude this obervation. observation(num_use=7):
```{r responses qqplot }
newdata<- Rawdata[Rawdata$num_use!=7,]  #1246
par(mfrow=c(2,2))
#1)skill_num
summary(newdata$num_use)
qqnorm(newdata$num_use)
qqline(newdata$num_use)

#2) skill_lit
summary(newdata$liter_use)
qqnorm(newdata$liter_use)
qqline(newdata$liter_use)

#3) test_num
summary(newdata$pvnumM)
qqnorm(newdata$pvnumM)
qqline(newdata$pvnumM)

#4) test_lit
summary(newdata$pvlitM)
qqnorm(newdata$pvlitM)
qqline(newdata$pvlitM)

```

The top left and top right Q-Q plot are not on a straight line. We might need some further transformation on the responses(num_use, liter_use)
 
The bottom left and bottom right Q-Q plot seem on a straight line so it is fair to say that the two responses(pvnumM, pvlitM) of our sample are normal distributed. The assumption of linear regression is statisfied.


### 2. Check Missing Value
```{r results= 'hide'}
nrow(newdata[is.na(newdata$Mgr),]) #501
nrow(newdata[is.na(newdata$GENDER_R),]) #0
nrow(newdata[is.na(newdata$ED_Level),]) #0
nrow(newdata[is.na(newdata$EMPloyed),]) #0
nrow(newdata[is.na(newdata$Full_part),]) #0
nrow(newdata[is.na(newdata$Years_wk),]) #0
nrow(newdata[is.na(newdata$work_flexM),]) #0
nrow(newdata[is.na(newdata$work_lrnM),]) #0
nrow(newdata[is.na(newdata$pub_priv),]) #40
nrow(newdata[is.na(newdata$NFE12),]) #0
nrow(newdata[is.na(newdata$FNFAET12),]) #0
nrow(newdata[is.na(newdata$FNFE12JR),]) #0
nrow(newdata[is.na(newdata$FNFAET12JR),]) #0
nrow(newdata[is.na(newdata$FNFAET12NJR),]) #0
nrow(newdata[is.na(newdata$NFEHRS),]) #0

```
There are 501 missing value in the 'Mgr' column, which is more than 40% of the total number of the observations. I would suggest that progressing our regression analysis without this variable first. 

There are 39 missing value in the 'pub_priv'. 
```{r pub_priv}
table(newdata$pub_priv)
```
From the table above, 1062 of the observations are from private sector while 145 of them are from Public sector. 

### 3.Check Variable
```{r}
##1.ED_Level
unique(newdata$ED_Level)
nrow(newdata[newdata$ED_Level == 8,]) #only one observation, changes it to 4
newdata<- within(newdata, ED_Level[ED_Level==8]<-4 )

##2.Categorical variable
newdata$pub_priv <- factor(newdata$pub_priv)
newdata$GENDER_R <- as.factor(newdata$GENDER_R)
newdata$ED_Level <- as.factor(newdata$ED_Level)
newdata$Full_part <- as.factor(newdata$Full_part)
newdata$NFE12 <- as.factor(newdata$NFE12)
newdata$FNFE12JR <- as.factor(newdata$FNFE12JR)
newdata$FNFAET12NJR <- as.factor(newdata$FNFAET12NJR)
newdata$FNFAET12JR <- as.factor(newdata$FNFAET12JR)

##3. "FNFAET12" "FNFAET12JR" "FNFAET12NJR" t-test:
#1)pvlitM
t.test(pvlitM~FNFAET12, data = newdata) #p-value < 2.2e-16
t.test(pvlitM~FNFAET12JR, data = newdata) #p-value = 9.813e-13
t.test(pvlitM~FNFAET12NJR, data = newdata) #p-value = 0.0001315

#2)pvnumM
t.test(pvnumM~FNFAET12, data = newdata) #p-value < 2.2e-16
t.test(pvnumM~FNFAET12JR, data = newdata) #p-value < 2.2e-16
t.test(pvnumM~FNFAET12NJR, data = newdata) #p-value = 6.66e-06
##they are all statistically significant and FNFAET12 is the union of other two variables.

##4.FNFE12JR and FNFAET12JR
table(data_priv$FNFE12JR == data_priv$FNFAET12JR)##They are exactly the same: use one of them


```
### 4. Correlations
```{r}
newdata.numeric<-newdata[,c("AGE_R","Years_wk","work_flexM","work_lrnM","act_lrn",
                            "NFEHRS","pvlitM","pvnumM")]
cor(newdata.numeric)
```


## 3. Methods
### 3-1. ANOVA for pvlitM
```{r}
#anova
# pvlitM vs gender
boxplot(pvlitM~GENDER_R,data=newdata, main="gender vs pvlitM", 
      xlab="gender", ylab="literacy score")
summary(aov(pvlitM~GENDER_R,data=newdata))

# pvlitM vs age
newdata$age_cat <-cut(newdata$AGE_R, c(49,55,60,65))
boxplot(pvlitM~age_cat,data=newdata, main="age vs pvlitM", 
      xlab="age", ylab="literacy score")
summary(aov(pvlitM~age_cat,data=newdata))


interaction.plot(newdata$GENDER_R, newdata$age_cat, newdata$pvlitM)
summary(aov(pvlitM~age_cat*GENDER_R,data=newdata))

# pvlitM vs full/part time
boxplot(pvlitM~Full_part,data=newdata, main="pvlitM vs full/part time", 
      xlab="full/part time", ylab="literacy score")
summary(aov(pvlitM~Full_part,data=newdata))

# pvlitM vs education
boxplot(pvlitM~ED_Level,data=newdata, main="pvlitM vs education", 
      xlab="education", ylab="literacy score")
summary(aov(pvlitM~ED_Level,data=newdata))

# pvlitM vs work year
newdata$Years_wk_cat <-cut(newdata$Years_wk, c(0,10,20,30,40,100), right=FALSE)
boxplot(pvlitM~Years_wk_cat,data=newdata, main="pvlitM vs work year", 
      xlab="work year", ylab="literacy score")
summary(aov(pvlitM~Years_wk_cat,data=newdata))

# pvlitM vs work_flexM
newdata$flex_cat <-cut(newdata$work_flexM, c(1,2,3,4,6), right=FALSE)
boxplot(pvlitM~flex_cat,data=newdata, main="pvlitM vs work flexibility", 
      xlab="work flexibility", ylab="literacy score")
summary(aov(pvlitM~flex_cat,data=newdata))

# pvlitM vs active learning
boxplot(pvlitM~act_lrn,data=newdata, main="pvlitM vs active learning", 
      xlab="active learning", ylab="literacy score")
summary(aov(pvlitM~act_lrn,data=newdata))

# pvlitM vs private/public
boxplot(pvlitM~Full_part,data=newdata, main="pvlitM vs private/public sector", 
      xlab="private/public sector", ylab="literacy score")
summary(aov(pvlitM~Full_part,data=newdata))

# pvlitM vs None formal education
boxplot(pvlitM~NFE12,data=newdata, main="pvlitM vs None formal education", 
      xlab="None formal education", ylab="literacy score")
summary(aov(pvlitM~NFE12,data=newdata))

# pvlitM vs adult eduction
boxplot(pvlitM~FNFAET12,data=newdata, main="pvlitM vs adult eduction", 
      xlab="adult eduction", ylab="literacy score")
summary(aov(pvlitM~FNFAET12,data=newdata))

# pvlitM vs adult eduction
unique(newdata$NFEHRS)
summary(lm(pvlitM~NFEHRS,data=newdata))
boxplot(pvlitM~NFEHRS,data=newdata, main="pvlitM vs eductaion", 
      xlab="adult eduction", ylab="literacy score")
summary(aov(pvlitM~NFEHRS,data=newdata))
```

### 3-2. ANOVA for pvnum
```{r}
# pvnum vs gender
boxplot(pvnumM~GENDER_R,data=newdata, main="gender vs pvnum", 
      xlab="gender", ylab="numeracy score")
summary(aov(pvnumM~GENDER_R,data=newdata))

# pvnum vs age
newdata$age_cat <-cut(newdata$AGE_R, c(49,55,60,65))
boxplot(pvnumM~age_cat,data=newdata, main="age vs pvnumM", 
      xlab="age", ylab="numeracy score")
summary(aov(pvnumM~age_cat,data=newdata))


interaction.plot(newdata$GENDER_R, newdata$age_cat, newdata$pvnumM)
summary(aov(pvnumM~age_cat*GENDER_R,data=newdata))

# pvnum vs full/part time
boxplot(pvnumM~Full_part,data=newdata, main="pvnumM vs full/part time", 
      xlab="full/part time", ylab="numeracy score")
summary(aov(pvnumM~Full_part,data=newdata))

# pvnum vs education
boxplot(pvnumM~ED_Level,data=newdata, main="pvnumM vs education", 
      xlab="education", ylab="numeracy score")
summary(aov(pvnumM~ED_Level,data=newdata))

# pvnum vs work year
boxplot(pvnumM~Years_wk_cat,data=newdata, main="pvnumM vs work year", 
      xlab="work year", ylab="numeracy score")
summary(aov(pvnumM~Years_wk_cat,data=newdata))
```


### 3-3.Stepwise AIC & BIC(including priv&public)
```{r}
#numeracy:
data_num<- newdata[,c(-3,-4,-6,-8,-11,-12,-15,-16,-18,-21,-22)]
data_num<- na.omit(data_num) #1207
full.num<-lm(pvnumM~.,data=data_num)
null.num<-lm(pvnumM~1,data=data_num)
step(null.lit,scope = list(lower=null.lit,upper=full.lit), direction="both", criterion = 
       "AIC", trace = F)   #ED_Level, act_lrn, Age, Gender, work_flexM,NFEHRS, public/private
step(null.lit,scope = list(lower=null.lit,upper=full.lit), direction="both", criterion = 
       "BIC", trace = F, k=log(nrow(data_num))) #ED_level, act_ln

#literacture:
data_lit<- newdata[,c(-3,-4,-6,-8,-11,-12,-15,-16,-19,-21,-22)] 
data_lit<- na.omit(data_lit) #1207
full.lit<-lm(pvlitM~.,data=data_lit)
null.lit<-lm(pvlitM~1,data=data_lit)
step(null.lit,scope = list(lower=null.lit,upper=full.lit),direction="both", criterion = 
      "AIC", trace = F)#ED_Level, act_lrn, Age, Gender, work_flexM,NFEHRS, public/private
step(null.lit,scope = list(lower=null.lit,upper=full.lit),direction="both", criterion = 
       "BIC", trace = F,k=log(nrow(data_lit))) #ED_Level, act_lrn


```

### 3-4. Stepwise AIC & BIC(exclude pub_priv)
I'll create a dataset called 'data_priv', which only contains the employees in private sector
```{r only priv}
data_priv <- newdata[newdata$pub_priv ==1 & (!is.na(newdata$pub_priv)), ] #1062
data_priv_lit<- data_priv[,c(-3,-4,-6,-8,-10,-11,-12,-15,-16,-19,-22)] 
data_priv_num<- data_priv[,c(-3,-4,-6,-8,-10,-11,-12,-15,-16,-18,-22)]

##1)numeracy
null.priv.num <- lm(pvnumM~1,data = data_priv_num)
full.priv.num <- lm(pvnumM~.,data = data_priv_num)
library(MASS)
#AIC
step(null.priv.num, scope = list(lower=null.priv.num,upper=full.priv.num), direction="both", criterion = "AIC",trace = F)  #ED_Level, act_lrn, Age, Gender, work_flexM,NFEHRS

#BIC
step(null.priv.num, scope = list(lower=null.priv.num,upper=full.priv.num), direction="both", criterion = "BIC",k=log(nrow(data_priv_num)),trace = F)#ED_level, act_lrn,Age,Gender
 

##2) Literacy
null.priv.lit<- lm(pvlitM~1,data=data_priv_lit)
full.priv.lit<- lm(pvlitM~.,data=data_priv_lit)

#AIC
step(null.priv.lit, scope = list(lower=null.priv.lit,upper=full.priv.lit), direction="both", criterion = "AIC",trace = F)  #ED_Level, act_lrn, Age, Gender, work_flexM,NFEHRS
#BIC
step(null.priv.lit, scope =list(lower=null.priv.lit,upper=full.priv.lit),direction="both", criterion = "BIC",k=log(nrow(data_priv_lit)),trace = F) #ED_Level, act_lrn, 
```

